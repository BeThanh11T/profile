<script>
  document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.endsWith(".csv")) {
      alert("⚠️ Vui lòng chọn đúng file .csv");
      return;
    }

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        let totalAK = 0;
        let validOrderSet = new Set(); // dùng để lọc trùng theo ID đơn hàng

        const keys = Object.keys(data[0]);
        const idKey = keys[0];      // Cột A: ID đơn hàng
        const statusKey = keys[1];  // Cột B: Trạng thái đơn hàng
        const akKey = keys[36];     // Cột AK: Hoa hồng

        data.forEach(row => {
          // Tổng tiền hoa hồng (AK)
          let raw = row[akKey];
          if (typeof raw === 'string') {
            raw = raw.replace(/₫|,/g, '').trim();
          }
          const value = parseFloat(raw);
          if (!isNaN(value)) totalAK += value;

          // Đếm đơn hàng hợp lệ (duy nhất)
          const status = row[statusKey]?.toLowerCase();
          const orderId = row[idKey]?.trim();

          if (orderId && !validOrderSet.has(orderId)) {
            if (status && !status.includes("hủy") && !status.includes("huỷ")) {
              validOrderSet.add(orderId);
            }
          }
        });

        const resultText =
          `🔢 Tiền hoa hồng: ${totalAK.toLocaleString('vi-VN')} ₫\n` +
          `📦 Số đơn hàng hợp lệ (không trùng): ${validOrderSet.size}`;
        document.getElementById('result').innerText = resultText;
      }
    });
  });

  function copyResult() {
    const text = document.getElementById('result').innerText;
    navigator.clipboard.writeText(text)
      .then(() => alert("✅ Đã sao chép vào clipboard!"))
      .catch(() => alert("❌ Không thể sao chép."));
  }
</script>
