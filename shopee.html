<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phân tích CSV Shopee</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial; padding: 30px; max-width: 650px; margin: auto; }
    input, textarea, button { width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; }
    button { background: #ee4d2d; color: white; border: none; cursor: pointer; }
    button:hover { background: #d94425; }
    #result { font-weight: bold; margin-top: 20px; color: #2c3e50; font-size: 18px; line-height: 1.6; }
  </style>
</head>
<body>

<h2>📊 Phân tích Shopee affiliate</h2>

<input type="file" id="csvFile" accept=".csv">
<div id="result">Chưa có dữ liệu.</div>
<button onclick="copyResult()">📋 Sao chép kết quả</button>

<script>
  document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        let totalAK = 0;
        let validOrders = 0;

        const keys = Object.keys(data[0]);
        const akKey = keys[36];     // Cột AK: vị trí 37 (index 36)
        const statusKey = keys[1];  // Cột B: Trạng thái đơn hàng

        data.forEach(row => {
          // Tổng cột AK
          let raw = row[akKey];
          if (typeof raw === 'string') {
            raw = raw.replace(/₫|,/g, '').trim(); // loại ký tự tiền tệ
          }
          const value = parseFloat(raw);
          if (!isNaN(value)) totalAK += value;

          // Đếm đơn hợp lệ
          const status = row[statusKey]?.toLowerCase();
          if (status && !status.includes("hủy") && !status.includes("huỷ")) {
            validOrders++;
          }
        });

        const resultText = 
          `🔢 <strong>Tiền hoa hồng:</strong> ${totalAK.toLocaleString('vi-VN')}<br>` +
          `📦 <strong>Số đơn hàng:</strong> ${validOrders}`;
        document.getElementById('result').innerHTML = resultText;
      }
    });
  });

  function copyResult() {
    const text = document.getElementById('result').innerText;
    navigator.clipboard.writeText(text)
      .then(() => alert("✅ Đã sao chép vào clipboard!"))
      .catch(() => alert("❌ Không thể sao chép."));
  }
</script>

</body>
</html>
