<script>
  document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.endsWith(".csv")) {
      alert("âš ï¸ Vui lÃ²ng chá»n Ä‘Ãºng file .csv");
      return;
    }

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        let totalAK = 0;
        let validOrderSet = new Set(); // dÃ¹ng Ä‘á»ƒ lá»c trÃ¹ng theo ID Ä‘Æ¡n hÃ ng

        const keys = Object.keys(data[0]);
        const idKey = keys[0];      // Cá»™t A: ID Ä‘Æ¡n hÃ ng
        const statusKey = keys[1];  // Cá»™t B: Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
        const akKey = keys[36];     // Cá»™t AK: Hoa há»“ng

        data.forEach(row => {
          // Tá»•ng tiá»n hoa há»“ng (AK)
          let raw = row[akKey];
          if (typeof raw === 'string') {
            raw = raw.replace(/â‚«|,/g, '').trim();
          }
          const value = parseFloat(raw);
          if (!isNaN(value)) totalAK += value;

          // Äáº¿m Ä‘Æ¡n hÃ ng há»£p lá»‡ (duy nháº¥t)
          const status = row[statusKey]?.toLowerCase();
          const orderId = row[idKey]?.trim();

          if (orderId && !validOrderSet.has(orderId)) {
            if (status && !status.includes("há»§y") && !status.includes("huá»·")) {
              validOrderSet.add(orderId);
            }
          }
        });

        const resultText =
          `ğŸ”¢ Tiá»n hoa há»“ng: ${totalAK.toLocaleString('vi-VN')} â‚«\n` +
          `ğŸ“¦ Sá»‘ Ä‘Æ¡n hÃ ng há»£p lá»‡ (khÃ´ng trÃ¹ng): ${validOrderSet.size}`;
        document.getElementById('result').innerText = resultText;
      }
    });
  });

  function copyResult() {
    const text = document.getElementById('result').innerText;
    navigator.clipboard.writeText(text)
      .then(() => alert("âœ… ÄÃ£ sao chÃ©p vÃ o clipboard!"))
      .catch(() => alert("âŒ KhÃ´ng thá»ƒ sao chÃ©p."));
  }
</script>
