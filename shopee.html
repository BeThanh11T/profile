<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ph√¢n t√≠ch Shopee Affiliate</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial; padding: 30px; max-width: 650px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; }
    button { background: #ee4d2d; color: white; border: none; cursor: pointer; }
    button:hover { background: #d94425; }
    #result { font-weight: bold; margin-top: 20px; color: #2c3e50; font-size: 18px; line-height: 1.6; white-space: pre-line; }
  </style>
</head>
<body>

<h2>üìä Ph√¢n t√≠ch Shopee Affiliate</h2>

<input type="file" id="csvFile">
<div id="result">Vui l√≤ng ch·ªçn file .csv ƒë·ªÉ ph√¢n t√≠ch...</div>
<button onclick="copyResult()">üìã Sao ch√©p k·∫øt qu·∫£</button>

<script>
  document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.endsWith(".csv")) {
      alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë√∫ng file .csv");
      return;
    }

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        let totalAK = 0;
        let validOrderSet = new Set();

        const keys = Object.keys(data[0]);
        const idKey = keys[0];      // C·ªôt A: ID ƒë∆°n h√†ng
        const statusKey = keys[1];  // C·ªôt B: Tr·∫°ng th√°i ƒë∆°n h√†ng
        const akKey = keys[36];     // C·ªôt AK: Hoa h·ªìng

        data.forEach(row => {
          // T√≠nh t·ªïng AK
          let raw = row[akKey];
          if (typeof raw === 'string') {
            raw = raw.replace(/‚Ç´|,/g, '').trim();
          }
          const value = parseFloat(raw);
          if (!isNaN(value)) totalAK += value;

          // L·ªçc ƒë∆°n h·ª£p l·ªá (kh√¥ng tr√πng)
          const status = row[statusKey]?.toLowerCase();
          const orderId = row[idKey]?.trim();

          if (orderId && !validOrderSet.has(orderId)) {
            if (status && !status.includes("h·ªßy") && !status.includes("hu·ª∑")) {
              validOrderSet.add(orderId);
            }
          }
        });

        const resultText =
          `üî¢ Ti·ªÅn hoa h·ªìng: ${totalAK.toLocaleString('vi-VN')} ‚Ç´\n` +
          `üì¶ S·ªë ƒë∆°n h√†ng: ${validOrderSet.size}`;
        document.getElementById('result').innerText = resultText;
      }
    });
  });

  function copyResult() {
    const text = document.getElementById('result').innerText;
    navigator.clipboard.writeText(text)
      .then(() => alert("‚úÖ ƒê√£ sao ch√©p v√†o clipboard!"))
      .catch(() => alert("‚ùå Kh√¥ng th·ªÉ sao ch√©p."));
  }
</script>

</body>
</html>
